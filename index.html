<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción de Emergencia - Consulta FUA v2.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-color: #0A2A43; --accent-color: #D4AF37; --text-color-light: #FFFFFF;
        --background-color: #f0f2f5; --success-color: #28a745; --danger-color: #dc3545;
    }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--background-color ); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
    .mobile-container { width: 390px; height: 700px; position: relative; overflow: hidden; border-radius: 45px; box-shadow: 0 15px 40px rgba(0,0,0,0.25); background: #ffffff; border: 12px solid #fff; }
    
    /* --- VISTAS DE PANTALLA COMPLETA --- */
    .fullscreen-view { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--background-color); z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; transition: opacity 0.3s, transform 0.3s; }
    .fullscreen-view.hidden { opacity: 0; pointer-events: none; transform: scale(0.95); }
    .login-box { width: 100%; max-width: 320px; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
    .login-box h2 { color: var(--primary-color); margin-top: 0; }
    .login-box input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
    .login-box button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-secondary { background: none; color: var(--primary-color); margin-top: 10px; }
    #password-prompt { z-index: 25; }
    #password-prompt .login-box { display: flex; flex-direction: column; }
    
    /* --- ESTRUCTURA PRINCIPAL --- */
    #main-app.hidden { display: none; }
    .header { position: absolute; top: 0; left: 0; right: 0; height: 90px; background: var(--primary-color); z-index: 5; display: flex; justify-content: center; align-items: center; }
    .header-title { color: var(--text-color-light); font-size: 24px; font-weight: bold; }
    .menu-button { position: absolute; left: 25px; z-index: 10; background: var(--primary-color); border: 2px solid var(--accent-color); border-radius: 30px; padding: 15px 25px; font-size: 16px; font-weight: 600; color: var(--text-color-light); cursor: pointer; min-width: 180px; }
    #btn-buscar { top: 120px; } #btn-observados { top: 190px; } #btn-ingreso { top: 260px; } #btn-info { top: 330px; } #btn-contacto { top: 400px; }
    .menu-button.active { background: var(--accent-color); color: var(--primary-color); border-color: var(--primary-color); }
    
    /* --- VISTA DE BÚSQUEDA --- */
    #search-view { position: absolute; top: 90px; left: 0; right: 0; bottom: 80px; padding: 20px; box-sizing: border-box; opacity: 1; z-index: 4; background: var(--background-color); display: flex; flex-direction: column; }
    .search-bar { display: flex; gap: 10px; align-items: center; }
    .search-bar input { flex-grow: 1; padding: 15px; border: 2px solid #ccc; border-radius: 10px; font-size: 16px; }
    .search-bar button { padding: 0 20px; height: 53px; background: var(--primary-color); color: white; border: none; border-radius: 10px; cursor: pointer; }
    .search-bar .mic-button { background: none; padding: 0 10px; }
    .search-bar .mic-button img { height: 30px; }
    .results-list { margin-top: 20px; overflow-y: auto; flex-grow: 1; }
    .result-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
    .result-item .status { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; }
    .status.consumo { background: #e8f5e9; color: #388e3c; }
    .status.sin-consumo { background: #fff3e0; color: #ef6c00; }
    
    /* --- MODO CHAT --- */
    #chat-view { position: absolute; bottom: 10px; left: 10px; right: 10px; z-index: 15; }
    .chat-log { max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
    .chat-message { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; max-width: 80%; }
    .user-message { background: var(--primary-color); color: white; align-self: flex-end; margin-left: auto; }
    .ia-message { background: #e9e9eb; color: #333; align-self: flex-start; }
    .input-bar { display: flex; align-items: center; background: white; border-radius: 30px; padding: 5px 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    #text-input { flex-grow: 1; border: none; background: none; outline: none; padding: 10px; font-size: 16px; }
    .action-button { background: none; border: none; cursor: pointer; padding: 8px; }
    
    /* --- PANEL ADMIN --- */
    #admin-view { z-index: 18; }
    .user-list { width: 100%; list-style: none; padding: 0; }
    .user-list li { background: white; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--success-color); }
    input:checked + .slider:before { transform: translateX(26px); }
</style>
</head>
<body>

    <div class="mobile-container">
        <!-- VISTA DE LOGIN/REGISTRO (INICIAL) -->
        <div id="login-view" class="fullscreen-view">
            <div class="login-box">
                <h2>Bienvenido</h2>
                <input type="text" id="username" placeholder="Usuario">
                <input type="password" id="password" placeholder="Contraseña">
                <button class="btn-primary" onclick="handleLogin()">Entrar</button>
                <button class="btn-secondary" onclick="showRegisterView()">Registrarse</button>
            </div>
        </div>
        <div id="register-view" class="fullscreen-view hidden">
            <div class="login-box">
                <h2>Crear Cuenta</h2>
                <input type="text" id="reg-name" placeholder="Nombre Completo">
                <input type="password" id="reg-password" placeholder="Contraseña">
                <input type="email" id="reg-email" placeholder="Correo Electrónico">
                <input type="tel" id="reg-phone" placeholder="Teléfono (WhatsApp)">
                <button class="btn-primary" onclick="handleRegister()">Registrar</button>
                <button class="btn-secondary" onclick="showLoginView()">Volver al Inicio</button>
            </div>
        </div>

        <!-- APLICACIÓN PRINCIPAL (OCULTA AL INICIO) -->
        <div id="main-app" class="hidden">
            <header id="main-header" class="header">
                <div id="header-title" class="header-title">Recepción Emergencia</div>
            </header>
            
            <!-- Vistas de la App -->
            <div id="search-view">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Buscar por FUA, Paciente...">
                    <button class="mic-button" onclick="handleVoiceSearch()">
                        <img src="https://lisa.fflch.usp.br/sites/lisa.fflch.usp.br/files/images/ICONES/audio%20icon.png" alt="Audio">
                    </button>
                    <button onclick="performSearch( )">Buscar</button>
                </div>
                <div class="results-list" id="results-list"></div>
            </div>

            <!-- Vistas de Admin e Ingreso (se mostrarán como overlays) -->
            <div id="admin-view" class="fullscreen-view hidden">
                <div class="login-box">
                    <h2>Panel de Administración</h2>
                    <ul class="user-list" id="user-list-container">
                        <!-- Los usuarios se cargarán aquí dinámicamente -->
                    </ul>
                    <button class="btn-secondary" onclick="closeAdminView()">Cerrar</button>
                </div>
            </div>
            <div id="ingreso-view" class="fullscreen-view hidden">
                <!-- Contenido del formulario de ingreso -->
            </div>
            <div id="password-prompt" class="fullscreen-view hidden">
                <div class="login-box">
                    <h3>Acceso a Ingresos</h3>
                    <input type="password" id="ingreso-password" placeholder="Contraseña de Ingreso">
                    <button class="btn-primary" onclick="checkIngresoPassword()">Acceder</button>
                    <button class="btn-secondary" onclick="closePasswordPrompt()">Cancelar</button>
                </div>
            </div>

            <!-- MODO CHAT -->
            <div id="chat-view">
                <div class="chat-log" id="chat-log"></div>
                <div class="input-bar">
                    <input type="text" id="text-input" placeholder="Haz una consulta..." onkeydown="if(event.key==='Enter') handleSend()">
                    <button class="action-button" onclick="handleSend()">➤</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- SIMULACIÓN DE BASE DE DATOS Y ESTADO ---
    let currentUser = null;
    const OPENROUTER_API_KEY = "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";
    // Simulación de la tabla de usuarios en Supabase
    let db_users = [
        { id: 1, name: 'manuel', email: 'admin@example.com', password: 'mutter', phone: '999888777', is_validated: true, role: 'admin' },
        { id: 2, name: 'Ana Lopez', email: 'ana@example.com', password: '123', phone: '987654321', is_validated: false, role: 'user' }
    ];

    // --- MANEJO DE VISTAS ---
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    const mainApp = document.getElementById('main-app');
    const adminView = document.getElementById('admin-view');

    function showLoginView() { registerView.classList.add('hidden'); loginView.classList.remove('hidden'); }
    function showRegisterView() { loginView.classList.add('hidden'); registerView.classList.remove('hidden'); }
    function showMainApp() { loginView.classList.add('hidden'); registerView.classList.add('hidden'); mainApp.classList.remove('hidden'); }
    function showAdminView() { adminView.classList.remove('hidden'); loadUsersToAdminPanel(); }
    function closeAdminView() { adminView.classList.add('hidden'); }

    // --- LÓGICA DE LOGIN Y REGISTRO ---
    function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        
        // Caso especial para Admin
        if (username === 'manuel' && password === 'mutter') {
            currentUser = db_users.find(u => u.name === 'manuel');
            initApp();
            showAdminView(); // Muestra el panel de admin directamente
            return;
        }

        const user = db_users.find(u => u.name === username && u.password === password);
        if (user) {
            if (user.is_validated) {
                currentUser = user;
                initApp();
            } else {
                alert("Tu cuenta aún no ha sido validada por un administrador.");
            }
        } else {
            alert("Usuario o contraseña incorrectos.");
        }
    }

    function handleRegister() {
        const name = document.getElementById('reg-name').value;
        // ... (obtener otros valores)
        alert(`Registro simulado para ${name}. Se ha enviado una notificación al administrador.`);
        // Aquí iría la llamada a Supabase para crear el usuario y el trigger para el email.
        showLoginView();
    }

    // --- INICIALIZACIÓN DE LA APP PRINCIPAL ---
    function initApp() {
        showMainApp();
        const chatLog = document.getElementById('chat-log');
        const now = new Date();
        const hour = now.getHours();
        let greeting = 'Hola';
        if (hour < 12) greeting = 'Buenos días';
        else if (hour < 18) greeting = 'Buenas tardes';
        else greeting = 'Buenas noches';
        
        chatLog.innerHTML = `<div class="ia-message">${greeting}, ${currentUser.name}. ¿En qué puedo ayudarte?</div>`;
    }

    // --- LÓGICA DE BÚSQUEDA POR VOZ (IA) ---
    async function handleVoiceSearch() {
        alert("Escuchando... Habla ahora. (Simulación de reconocimiento de voz)");
        // 1. Simular que el usuario habla
        const spokenText = "buscar fua 46267245 y paciente maría garcía"; // Texto de ejemplo
        
        // 2. Enviar a OpenRouter para procesar
        document.getElementById('search-input').value = "Procesando voz con IA...";
        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": "mistralai/mistral-7b-instruct:free",
                    "messages": [
                        { "role": "system", "content": "Extrae los números de FUA y nombres de paciente del siguiente texto. Devuelve solo los valores separados por comas." },
                        { "role": "user", "content": spokenText }
                    ]
                } )
            });
            const data = await response.json();
            const processedText = data.choices[0].message.content;
            document.getElementById('search-input').value = processedText;
            performSearch();
        } catch (error) {
            alert("Error al procesar la voz con IA.");
            document.getElementById('search-input').value = "";
        }
    }
    
    function performSearch() {
        const query = document.getElementById('search-input').value;
        alert(`Búsqueda simulada en Supabase para: "${query}"`);
    }

    // --- LÓGICA DEL PANEL DE ADMIN ---
    function loadUsersToAdminPanel() {
        const container = document.getElementById('user-list-container');
        container.innerHTML = '';
        db_users.filter(u => u.role !== 'admin').forEach(user => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    <strong>${user.name}</strong>  

                    <small><a href="https://wa.me/51${user.phone}" target="_blank">Contactar</a></small>
                </div>
                <label class="switch">
                    <input type="checkbox" ${user.is_validated ? 'checked' : ''} onchange="toggleUserValidation(${user.id} )">
                    <span class="slider"></span>
                </label>
            `;
            container.appendChild(li);
        });
    }

    function toggleUserValidation(userId) {
        // Simulación de actualizar la BD
        const user = db_users.find(u => u.id === userId);
        user.is_validated = !user.is_validated;
        alert(`El usuario ${user.name} ahora está ${user.is_validated ? 'ACTIVADO' : 'DESACTIVADO'}.`);
    }

</script>
</body>
</html>



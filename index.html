<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recepción de Emergencia</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- ESTILOS DEL DISEÑO "IMPACTO" (CORREGIDO ) --- */
        :root {
            --primary-color: #0A2A43; /* Azul oscuro */
            --accent-color: #D4AF37; /* Dorado/Amarillo */
            --text-color-light: #FFFFFF;
            --background-color: #FFFFFF; /* Fondo del contenedor blanco */
            --body-bg-color: #f0f2f5; /* Fondo exterior gris claro */
        }
        body {
            margin: 0; font-family: 'Inter', sans-serif; background: var(--body-bg-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden;
        }
        #phone-container {
            width: 390px; height: 700px; position: relative; overflow: hidden; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); background: var(--background-color);
        }
        #main-app {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; z-index: 2;
        }
        #background-logo {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; opacity: 0.08; z-index: 1; pointer-events: none;
        }
        .app-view {
            display: none; flex-direction: column; flex-grow: 1; padding: 20px; padding-top: 100px; box-sizing: border-box;
        }
        .app-view.active { display: flex; }
        #header {
            position: absolute; top: 0; left: 0; right: 0; height: 80px; background: var(--primary-color); color: var(--text-color-light); display: flex; align-items: center; justify-content: center; padding: 0 20px; z-index: 10; border-radius: 20px 20px 0 0;
        }
        #back-button {
            position: absolute; left: 15px; background: none; border: none; color: white; font-size: 32px; cursor: pointer;
        }
        #view-title { font-size: 1.5em; font-weight: bold; }
        #login-view, #register-view { padding-top: 20px; justify-content: center; background: var(--primary-color); } /* Fondo azul para login */
        .form-container {
            width: 100%; max-width: 300px; margin: 0 auto; padding: 30px; background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        h1, h2 { color: var(--primary-color); text-align: center; }
        input[type="text"], input[type="password"], input[type="email"], input[type="tel"], input[type="date"] {
            width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em;
        }
        button {
            width: 100%; padding: 12px; border: 2px solid var(--accent-color); border-radius: 30px; background-color: var(--primary-color); color: var(--text-color-light); font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        button:hover { background-color: #082135; transform: translateY(-2px); }
        .secondary-action {
            background: none; border: none; color: var(--primary-color); margin-top: 10px; font-size: 0.9em;
        }
        #main-menu-view { padding-top: 100px; }
        #main-menu-view .menu-buttons { display: flex; flex-direction: column; gap: 15px; padding: 0 30px; }
        #greeting-container {
            text-align: center; padding: 12px; background: #e9ecef; border-radius: 10px; color: #333; margin: 25px 30px 0; font-size: 0.95em;
        }
        /* Estilos para las vistas internas */
        #search-results, #observados-list, #user-list-container { list-style: none; padding: 0; margin-top: 10px; overflow-y: auto; }
        #search-results li, #observados-list li, #user-list-container li { background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #333; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 10px; width: 90%; max-width: 370px; position: relative; color: #333; }
        #modal-close-btn { position: absolute; top: 5px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        #modal-details-content p strong { color: var(--primary-color); }
    </style>
</head>
<body>
    <div id="phone-container">
        <img id="background-logo" src="https://i.ibb.co/L631h3D/logo-cayetano.png" alt="Logo Hospital" style="display: none;">
        <div id="main-app">
            <div id="header">
                <button id="back-button" onclick="goBack( )" style="display: none;">&#x2190;</button>
                <span id="view-title"></span>
            </div>
            <div id="login-view" class="app-view active">
                <div class="form-container">
                    <h1>Bienvenido</h1>
                    <input type="text" id="username" placeholder="Usuario">
                    <input type="password" id="password" placeholder="Contraseña">
                    <button onclick="handleLogin()">Ingresar</button>
                    <button class="secondary-action" onclick="showView('register-view', 'Registro')">Registrarse</button>
                </div>
            </div>
            <div id="register-view" class="app-view">
                <div class="form-container">
                    <h2>Registro</h2>
                    <input type="text" id="reg-fullname" placeholder="Nombre Completo">
                    <input type="password" id="reg-password" placeholder="Contraseña">
                    <input type="email" id="reg-email" placeholder="Email">
                    <input type="tel" id="reg-whatsapp" placeholder="Nº WhatsApp (9 dígitos)">
                    <button onclick="handleRegister()">Registrar</button>
                    <button class="secondary-action" onclick="showView('login-view', 'Recepción Emergencia')">Volver al Login</button>
                </div>
            </div>
            <div id="main-menu-view" class="app-view">
                <div class="menu-buttons">
                    <button onclick="showView('search-view', 'Buscar FUA')">Buscar FUA</button>
                    <button onclick="showView('ver-observados-view', 'Ver Observados')">Ver Observados</button>
                    <button id="btn-admin" onclick="showView('admin-view', 'Administración')" style="display: none;">Administrar</button>
                    <button onclick="showInfo()">Información</button>
                    <button onclick="showContact()">Contacto</button>
                </div>
                <div id="greeting-container" style="display: none;"></div>
            </div>
            <div id="search-view" class="app-view">
                <input type="text" id="search-input" placeholder="Buscar...">
                <ul id="search-results"></ul>
            </div>
            <div id="ver-observados-view" class="app-view">
                <input type="text" id="observados-search-input" placeholder="Filtrar...">
                <ul id="observados-list"></ul>
            </div>
            <div id="admin-view" class="app-view"></div>
        </div>
    </div>
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span id="modal-close-btn">&times;</span>
            <div id="modal-details-content"></div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://rpncjtakgljxhbvelgdh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbmNqdGFrZ2xqeGhidmVsZ2RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwODUzMzAsImV4cCI6MjA3NjY2MTMzMH0.mEcAP4NSJQGYYgx3nmuSkYWRX2UkmJiiKZq9sv7UUq4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY );

    let currentUser = null;
    let viewStack = ['login-view'];

    const viewTitle = document.getElementById('view-title');
    const backButton = document.getElementById('back-button');
    const backgroundLogo = document.getElementById('background-logo');

    function showView(viewId, title) {
        document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
        const targetView = document.getElementById(viewId);
        if(targetView) targetView.classList.add('active');

        const isMain = viewId === 'main-menu-view';
        const isLoginOrRegister = viewId === 'login-view' || viewId === 'register-view';

        backButton.style.display = isMain || isLoginOrRegister ? 'none' : 'block';
        viewTitle.textContent = title;
        backgroundLogo.style.display = isMain ? 'block' : 'none';
        
        if (viewId !== viewStack[viewStack.length - 1]) {
            viewStack.push(viewId);
        }

        const greeting = document.getElementById('greeting-container');
        if (isMain && currentUser) {
            const hour = new Date().getHours();
            const saludo = hour < 12 ? 'Buenos días' : hour < 18 ? 'Buenas tardes' : 'Buenas noches';
            greeting.textContent = `${saludo}, ${currentUser.nombre_completo.split(' ')[0]}`;
            greeting.style.display = 'block';
        } else {
            greeting.style.display = 'none';
        }
    }

    function goBack() {
        if (viewStack.length > 1) {
            viewStack.pop();
            const prevViewId = viewStack[viewStack.length - 1];
            const prevTitle = prevViewId === 'login-view' || prevViewId === 'main-menu-view' ? 'Recepción Emergencia' : 'Volver';
            showView(prevViewId, prevTitle);
        }
    }
    
    async function handleLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (!username || !password) return alert('Por favor, ingrese usuario y contraseña.');

        if (username.toLowerCase() === 'manuel' && password === 'mutter') {
            currentUser = { nombre_completo: 'Manuel (Admin)', rol: 'admin' };
            document.getElementById('btn-admin').style.display = 'block';
            showView('main-menu-view', 'Recepción Emergencia');
            return;
        }
        
        try {
            const { data, error } = await supabaseClient.rpc('login_usuario', { p_nombre_completo: username, p_contrasena: password });
            if (error || !data || data.length === 0) throw new Error('Usuario o contraseña incorrectos.');
            
            const user = data[0];
            if (!user.esta_validado) return alert('Usuario no validado.');
            
            currentUser = user;
            document.getElementById('btn-admin').style.display = user.rol === 'admin' ? 'block' : 'none';
            showView('main-menu-view', 'Recepción Emergencia');
        } catch (error) {
            alert(error.message);
        }
    }

    async function handleRegister() {
        const fullName = document.getElementById('reg-fullname').value.trim();
        const password = document.getElementById('reg-password').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const whatsapp = document.getElementById('reg-whatsapp').value.trim();

        if (!password || !fullName) return alert("Por favor, complete los campos de Nombre y Contraseña.");

        try {
            const { error } = await supabaseClient.from('usuarios').insert({ nombre_completo: fullName, contrasena: password, email: email, telefono_whatsapp: whatsapp, rol: 'user', esta_validado: false });
            if (error) throw error;
            alert("¡Registro exitoso! Por favor, espera a que un administrador valide tu cuenta.");
            showView('login-view', 'Recepción Emergencia');
        } catch (error) {
            alert(`Error en el registro: ${error.message}`);
        }
    }

    function showInfo() { alert("Función 'Información' en desarrollo."); }
    function showContact() { window.open('https://wa.me/51967188120', '_blank' ); }

    document.addEventListener('DOMContentLoaded', () => {
        showView('login-view', 'Recepción Emergencia');
        document.getElementById('password').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
    });
</script>
</body>
</html>
